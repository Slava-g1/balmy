"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.reduceTimeout = exports.timeoutPromise = exports.TimeoutError = void 0;
const ms_1 = __importDefault(require("ms"));
class TimeoutError extends Error {
    constructor(description, timeout) {
        super(`${description} timeouted at ${typeof timeout === 'number' ? `${timeout}ms` : timeout}`);
    }
}
exports.TimeoutError = TimeoutError;
function timeoutPromise(promise, timeout, options) {
    if (!timeout)
        return promise;
    const realTimeout = options?.reduceBy ? reduceTimeout(timeout, options.reduceBy) : timeout;
    const timeoutMs = typeof realTimeout === 'number' ? realTimeout : (0, ms_1.default)(realTimeout);
    return new Promise((resolve, reject) => {
        const timer = setTimeout(() => {
            options?.onTimeout?.(realTimeout);
            reject(new TimeoutError(options?.description ?? 'Promise', timeout));
        }, timeoutMs);
        promise
            .then(resolve)
            .catch(reject)
            .finally(() => clearTimeout(timer));
    });
}
exports.timeoutPromise = timeoutPromise;
function reduceTimeout(timeout, reduceBy) {
    if (!timeout)
        return undefined;
    const millisTimeout = typeof timeout === 'number' ? timeout : (0, ms_1.default)(timeout);
    const millisToTakeOut = (0, ms_1.default)(reduceBy);
    return millisTimeout > millisToTakeOut
        ? (millisTimeout - millisToTakeOut).toString()
        : Math.floor((millisTimeout * 3) / 4).toString();
}
exports.reduceTimeout = reduceTimeout;
//# sourceMappingURL=timeouts.js.map